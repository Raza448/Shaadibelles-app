'use strict';

/**
 * @ngdoc function
 * @name webApp.controller:AboutCtrl
 * @description
 * # AboutCtrl
 * Controller of the webApp
 */
angular.module('sbFrontEnd').controller('VendorSignupTwoCtrl', function ($scope, $http, $rootScope, $cookieStore, $location, File) {
    angular.element("#toTop").click();
     $rootScope.showSelect = false;
    $scope.vendor = {
       category : [null, null],
       location : [null, null],
       website : null,
       business : {},
       social : {},
       billing : {},
       gallery : []
    };

 $scope.gallery = {
  title : null,
  photos : [],
  cover : null
 };

  $scope.locationOne = null;
  $scope.locationTwo = null;
 $scope.$watch('locationOne', function(location){
  if(location){
  $scope.vendor.location[0] = location;
}
});

 $scope.$watch('locationTwo', function(location){
  if(location){
  $scope.vendor.location[1] = location;
}
});

  $scope.categoryOne = null;
  $scope.categoryTwo = null;
  $scope.$watch('categoryOne', function(category){
  if(category){
  $scope.vendor.category[0] = category;
}
});


$http.get('/credentials').then(function(res) {
                if (res.data) {
                    $rootScope.user = { id : res.data.userId,
                    accessToken :  res.data.accessToken }
                }
            
            });

$rootScope.$watch('user', function(user){
  var url = window.remote + '/api/users/' + $rootScope.user.id + '?access_token=' + $rootScope.user.accessToken;
    $http.get(url).then(function(res){
            $scope.vendor.business = res.data.business || {};
            $scope.vendor.social = res.data.social || {};
            $scope.vendor.gallery = res.data.gallery || [];      
            $scope.categoryOne =  res.data.category[0] || null;
            $scope.categoryTwo =  res.data.category[1] || null;
            $scope.locationOne = res.data.location[0] || null;
            $scope.locationTwo = res.data.location[1] || null;
            $scope.vendor.website = res.data.website || null;
           $scope.vendor.billing = res.data.billing ||  {};
         $http.get(window.remote + '/api/users/' + $rootScope.user.id + '/galleries?access_token=' + $rootScope.user.accessToken).then(function(res){
           $scope.gallery = res.data;        
    });
    });
   
});


 

 $scope.$watch('categoryTwo', function(category){
  if(category){
  $scope.vendor.category[1] = category;
}
});

  $scope.step1 = false;
  $scope.step2 = true;
  $scope.step3 = true;

  $rootScope.countries = window.countries;
  $rootScope.vendorCategories = window.vendorTypes;
    $scope.save = function(){
    var url = window.remote + '/api/users/' + $rootScope.user.id + '?access_token=' + $rootScope.user.accessToken;
    $http.put(url, $scope.vendor).then(function(res){
            $scope.vendor.business = res.data.business || {};
            $scope.vendor.social = res.data.social || {};
            $scope.vendor.gallery = res.data.gallery || [];      
            $scope.vendor.category =  res.data.category || [null, null];
            $scope.vendor.location = res.data.location ||  [null, null];
            $scope.vendor.website = res.data.website || null;
           $scope.vendor.billing = res.data.billing ||  {}
        var request = $http.post;
            $scope.gallery.title = res.data.business.title;
            $scope.gallery.cover = res.data.gallery[0];
              if($scope.gallery.id){
                 request  = $http.put;
              }
               request(window.remote + '/api/users/' + $rootScope.user.id + '/galleries?access_token=' + $rootScope.user.accessToken, $scope.gallery).then(function(res){
            $scope.gallery = res.data;
              });
         

    });
    
   };

 $scope.upload = function(file) {
           if(file){
$scope.uploadCover = function(file) {
  var text = "";
    var ext = file.name.split('.').pop();

    var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

    for( var i=0; i < 5; i++ ) {
        text += possible.charAt(Math.floor(Math.random() * possible.length));
    }


    file.fileName = text + '.' + ext;
      File.upload(file).success(function(res) {

        var containerName = res.result.files.img[0].container;
        var fileName = res.result.files.img[0].name;
        var newfile = 'https://' + containerName + '.s3.amazonaws.com/' +
          fileName;
        $scope.post.cover = newfile;
      })
    }

     File.upload(file).success(function(res) {
        var containerName = res.result.files.img[0].container;
        var fileName = res.result.files.img[0].name;
        var newfile = 'https://' + containerName + '.s3.amazonaws.com/' +
          fileName;
        $scope.vendor.gallery.push(newfile);
        $scope.gallery.photos.push(newfile);
      })
}
    }

   $scope.saveStep1 = function(){
     $scope.save();
     $scope.step1 = true;
 window.scrollTo(0, 600);
    $scope.step2 = false;
   };

   $scope.saveStep2 = function(){
     $scope.save();
     $scope.step2 = true;
 window.scrollTo(0, 1100);
    $scope.step3 = false;
   };

   $scope.handleStripe = function(status, response) {

    if (response.error) {
  
    } else {
      var data = {
        'userId': $rootScope.user.id,
        'token' : response.id
      }
      $http.post( window.remote + '/api/users/subscribe?access_token=' + $rootScope.user.accessToken, data).then(function(res) {

         location.href = '#/main/home';

      });


    }
  }



});

